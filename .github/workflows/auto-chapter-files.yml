name: Auto-create chapter structure and navigation

on:
  push:
    paths:
      - 'UE*/**/'

jobs:
  build-chapter-structure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find all chapter folders
        id: find_folders
        run: |
          echo "chapters<<EOF" >> $GITHUB_OUTPUT
          find UE* -type d -name "Chapitre*" | sort >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate default files and Markdown
        run: |
          for folder in ${{ steps.find_folders.outputs.chapters }}; do
            echo "Processing $folder"
            chapter_name=$(basename "$folder")
            parent_folder=$(basename $(dirname "$folder"))
            ue_folder=$(basename $(dirname $(dirname "$folder")))

            ########################################
            # 1️⃣ Static files
            ########################################
            for f in schema.svg demo.html exemple.pdf image.jpg photo.jpeg document.docx tableur.xls; do
              if [ ! -f "$folder/$f" ]; then
                if [[ $f == *.svg ]]; then
                  cat << 'EOF' > "$folder/schema.svg"
<svg width="200" height="100" xmlns="http://www.w3.org/2000/svg">
  <rect x="10" y="10" width="180" height="80" fill="lightgray" stroke="black"/>
  <text x="100" y="55" font-size="14" text-anchor="middle">Schéma Exemple</text>
</svg>
EOF
                elif [[ $f == *.html ]]; then
                  cat << 'EOF' > "$folder/demo.html"
<!DOCTYPE html>
<html lang="fr">
<head><meta charset="UTF-8"><title>Démonstration</title></head>
<body><h1>Démo HTML</h1><p>Page générée automatiquement.</p></body>
</html>
EOF
                else
                  touch "$folder/$f"
                fi
              fi
            done

            ########################################
            # 2️⃣ Markdown files for chapter
            ########################################
            for md_file in fiche_synthese.md fiche_clinique.md; do
              if [ ! -f "$folder/$md_file" ]; then
                cat <<EOF > "$folder/$md_file"
---
title: "${chapter_name} — ${md_file%%.md}"
parent: "${parent_folder}"
grand_parent: "${ue_folder}"
nav_order: 1
---

# ${chapter_name} — ${md_file%%.md}

Ce fichier a été généré automatiquement.

## Ressources du chapitre

- [Schéma SVG](schema.svg)
- [Document PDF](exemple.pdf)
- [Démonstration HTML](demo.html)
- [Image JPG](image.jpg)
- [Image JPEG](photo.jpeg)
- [Document Word (DOCX)](document.docx)
- [Tableur Excel (XLS)](tableur.xls)

Ajoutez votre contenu ici.
EOF
              fi
            done

            ########################################
            # 3️⃣ Create index.md for parent (Sous-UE) if missing
            ########################################
            if [ ! -f "$(dirname "$folder")/index.md" ]; then
              cat <<EOF > "$(dirname "$folder")/index.md"
---
title: "${parent_folder}"
nav_order: 1
---

# ${parent_folder}

Index automatique pour le Sous-UE : ${parent_folder}
EOF
            fi

            ########################################
            # 4️⃣ Create index.md for UE if missing
            ########################################
            if [ ! -f "$(dirname $(dirname "$folder"))/index.md" ]; then
              cat <<EOF > "$(dirname $(dirname "$folder"))/index.md"
---
title: "${ue_folder}"
nav_order: 1
---

# ${ue_folder}

Index automatique pour l'UE : ${ue_folder}
EOF
            fi

          done

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-add chapter structure, static files, markdown, and navigation"
